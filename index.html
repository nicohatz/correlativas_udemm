<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Materias | UdeMM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        udemm: {
                            blue: '#003366',
                            light: '#e6f0fa',
                            accent: '#facc15',
                            hoverLight: '#f0f7ff' // Color para el hover en modo claro
                        }
                    },
                    // Animaci√≥n personalizada para el dropdown
                    animation: {
                        'slide-down-fade': 'slideDownFade 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideDownFade: {
                            '0%': { opacity: 0, transform: 'translateY(-10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .materia-card { transition: all 0.2s ease-in-out, border-color 0.3s; }
        .materia-card:hover { transform: translateY(-2px); }
        
        /* Clase de utilidad para rotar la flecha */
        .rotate-180-ico { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen">

    <nav class="bg-udemm-blue dark:bg-gray-950 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üéì</span>
                    <span class="font-bold text-xl tracking-wide">Planificador UdeMM</span>
                </div>
                <button id="theme-toggle" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
                    <span id="theme-icon">üåô</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="mb-8 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-black dark:border-gray-700 flex flex-col sm:flex-row gap-4 items-center justify-between relative z-20">
            <div class="w-full sm:w-1/2 relative">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Seleccionar Carrera</label>
                
                <div class="relative">
                    <button id="custom-select-button" type="button" class="w-full bg-gray-50 dark:bg-gray-700 border border-black dark:border-gray-600 text-gray-900 dark:text-white rounded-lg p-2.5 pr-10 text-left focus:ring-2 focus:ring-udemm-blue focus:border-transparent transition-all flex items-center justify-between">
                        <span id="selected-value-text" class="truncate">Cargando carreras...</span>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none transition-transform duration-200" id="dropdown-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </span>
                    </button>

                    <ul id="custom-select-list" class="absolute z-50 mt-1 w-full bg-white dark:bg-gray-800 shadow-xl max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden border border-gray-200 dark:border-gray-700">
                        </ul>
                </div>
                 </div>
            <div class="text-right w-full sm:w-1/2">
                <p class="text-sm text-gray-500 dark:text-gray-400">Progreso de la carrera</p>
                <p class="text-2xl font-bold text-udemm-blue dark:text-udemm-accent" id="progress-text">0 / 0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 relative z-10">
            <div class="lg:col-span-2 space-y-6" id="plan-container">
                <h2 class="text-2xl font-bold border-b-2 border-udemm-blue dark:border-gray-700 pb-2">Plan de Estudios</h2>
                <div id="loading-msg" class="text-gray-500 animate-pulse">Cargando datos...</div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-black dark:border-gray-700 sticky top-24 overflow-hidden">
                    <div class="bg-udemm-blue dark:bg-gray-950 text-white p-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span>‚úÖ</span> Disponibles para Cursar
                        </h2>
                        <p class="text-sm text-udemm-light mt-1">Materias con correlativas aprobadas</p>
                    </div>
                    <div class="p-4 space-y-3 max-h-[70vh] overflow-y-auto" id="disponibles-container">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Variables globales
        let db;
        let carreraActual;
        let materiasAprobadas;
        let isDropdownOpen = false; // Estado del nuevo dropdown

        const numToRoman = { 1: 'Primer A√±o', 2: 'Segundo A√±o', 3: 'Tercer A√±o', 4: 'Cuarto A√±o', 5: 'Quinto A√±o' };

        // Elementos del DOM para el custom select
        const selectButton = document.getElementById('custom-select-button');
        const selectList = document.getElementById('custom-select-list');
        const selectedValueText = document.getElementById('selected-value-text');
        const dropdownArrow = document.getElementById('dropdown-arrow');

        async function cargarDatos() {
            try {
                const respuesta = await fetch('datos.json');
                if (!respuesta.ok) throw new Error("Error al cargar el archivo JSON");
                db = await respuesta.json();
                
                // Inicializar con la primera carrera
                carreraActual = db.carreras[0];
                materiasAprobadas = new Set(JSON.parse(localStorage.getItem(`aprobadas_${carreraActual.id}`) || '[]'));
                
                document.getElementById('loading-msg').remove();
                inicializarUI();
                
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('plan-container').innerHTML = `
                    <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700">
                        <p class="font-bold">Error al cargar los datos</p>
                        <p>Asegurate de usar un servidor local.</p>
                    </div>
                `;
            }
        }

        function inicializarUI() {
            // --- L√ìGICA DEL CUSTOM SELECT ---
            
            // 1. Llenar la lista con opciones personalizadas
            selectList.innerHTML = '';
            db.carreras.forEach(c => {
                const li = document.createElement('li');
                li.className = `cursor-pointer select-none relative py-3 pl-3 pr-9 text-gray-900 dark:text-gray-200 hover:bg-udemm-hoverLight dark:hover:bg-gray-700 transition-colors duration-150 flex items-center`;
                // Marcamos la opci√≥n activa
                if(c.id === carreraActual.id) {
                    li.classList.add('font-semibold', 'bg-udemm-hoverLight', 'dark:bg-gray-700', 'text-udemm-blue', 'dark:text-udemm-accent');
                }
                
                li.textContent = c.nombre;
                
                // Evento al hacer clic en una opci√≥n
                li.addEventListener('click', () => {
                    seleccionarCarrera(c.id);
                    toggleDropdown(false);
                });
                selectList.appendChild(li);
            });

            // 2. Establecer el texto inicial del bot√≥n
            selectedValueText.textContent = carreraActual.nombre;

            // 3. Renderizar el resto de la app
            renderizarPlan();
            actualizarUI();
            checkTheme();
        }

        // --- FUNCIONES DEL CUSTOM SELECT ---

        function toggleDropdown(forceState) {
            isDropdownOpen = forceState !== undefined ? forceState : !isDropdownOpen;
            
            if (isDropdownOpen) {
                selectList.classList.remove('hidden');
                selectList.classList.add('animate-slide-down-fade'); // A√±adir animaci√≥n de entrada
                dropdownArrow.classList.add('rotate-180-ico');
            } else {
                 selectList.classList.add('hidden');
                 selectList.classList.remove('animate-slide-down-fade');
                 dropdownArrow.classList.remove('rotate-180-ico');
            }
        }

        // Nueva funci√≥n centralizada para cambiar de carrera
        function seleccionarCarrera(carreraId) {
            if (carreraActual.id === carreraId) return; // No hacer nada si es la misma

            carreraActual = db.carreras.find(c => c.id === carreraId);
            materiasAprobadas = new Set(JSON.parse(localStorage.getItem(`aprobadas_${carreraActual.id}`) || '[]'));
            
            // Actualizar texto del bot√≥n y la UI
            selectedValueText.textContent = carreraActual.nombre;
            
            // Re-renderizar la lista para actualizar el estilo de "activo"
            inicializarUI(); 
        }

        // --- EVENT LISTENERS DEL CUSTOM SELECT ---
        
        // Click en el bot√≥n principal
        selectButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Evitar que cierre inmediatamente
            toggleDropdown();
        });

        // Cerrar al hacer clic afuera
        window.addEventListener('click', (e) => {
            if (isDropdownOpen && !selectButton.contains(e.target) && !selectList.contains(e.target)) {
                toggleDropdown(false);
            }
        });


        // --- FUNCIONES CORE DE LA APP (Sin cambios mayores) ---

        function checkTheme() {
            const isDark = localStorage.getItem('theme') === 'dark';
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function toggleMateria(nombre) {
            if (materiasAprobadas.has(nombre)) {
                materiasAprobadas.delete(nombre);
            } else {
                materiasAprobadas.add(nombre);
            }
            localStorage.setItem(`aprobadas_${carreraActual.id}`, JSON.stringify([...materiasAprobadas]));
            actualizarUI();
        }

        function renderizarPlan() {
            const container = document.getElementById('plan-container');
            container.innerHTML = '<h2 class="text-2xl font-bold border-b-2 border-udemm-blue dark:border-gray-700 pb-2">Plan de Estudios</h2>';

            const porAnio = {};
            carreraActual.materias.forEach(m => {
                if(!porAnio[m.a√±o]) porAnio[m.a√±o] = [];
                porAnio[m.a√±o].push(m);
            });

            for (let i = 1; i <= 5; i++) {
                if(!porAnio[i]) continue;
                
                let htmlAnio = `
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-3 bg-gray-200 dark:bg-gray-800 px-3 py-1 rounded-md inline-block">${numToRoman[i]}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                `;

                porAnio[i].forEach(m => {
                    let reqText = m.correlativas.length > 0 ? `Requiere: ${m.correlativas.join(', ')}` : 'Sin correlativas';
                    
                    htmlAnio += `
                        <label class="materia-card flex items-start gap-3 p-4 bg-white dark:bg-gray-800 border border-black dark:border-gray-700 rounded-xl cursor-pointer hover:shadow-md">
                            <input type="checkbox" 
                                   class="mt-1 w-5 h-5 text-udemm-blue rounded focus:ring-udemm-blue" 
                                   value="${m.nombre}"
                                   onchange="toggleMateria('${m.nombre}')"
                                   ${materiasAprobadas.has(m.nombre) ? 'checked' : ''}>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-900 dark:text-gray-100 leading-tight">${m.nombre}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${reqText}</p>
                            </div>
                        </label>
                    `;
                });

                htmlAnio += `</div></div>`;
                container.innerHTML += htmlAnio;
            }
        }

        function actualizarUI() {
            const total = carreraActual.materias.length;
            const aprobadasCount = materiasAprobadas.size;
            document.getElementById('progress-text').textContent = `${aprobadasCount} / ${total}`;

            const habilitadas = [];
            carreraActual.materias.forEach(m => {
                if (materiasAprobadas.has(m.nombre)) return;
                
                if(m.correlativas.includes("Todas las materias previas")) {
                    if(aprobadasCount >= total - 1) habilitadas.push(m.nombre);
                    return;
                }

                const puedeCursar = m.correlativas.every(req => materiasAprobadas.has(req));
                if (puedeCursar) {
                    habilitadas.push(m.nombre);
                }
            });

            const dispContainer = document.getElementById('disponibles-container');
            dispContainer.innerHTML = '';
            
            if (habilitadas.length === 0) {
                dispContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center py-4 italic">${aprobadasCount === total ? '¬°Felicitaciones! Terminaste la cursada. üéâ' : 'Aprob√° m√°s materias para desbloquear nuevas.'}</p>`;
            } else {
                habilitadas.forEach(mat => {
                    dispContainer.innerHTML += `
                        <div class="p-3 bg-blue-50 dark:bg-gray-700 border-l-4 border-udemm-blue dark:border-udemm-accent rounded-r-lg shadow-sm">
                            <p class="font-medium text-gray-800 dark:text-gray-200">${mat}</p>
                        </div>
                    `;
                });
            }
        }

        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        window.addEventListener('DOMContentLoaded', cargarDatos);

    </script>
</body>
</html>

